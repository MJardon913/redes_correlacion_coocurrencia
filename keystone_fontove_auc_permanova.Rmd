---
title: "keystone_fontove_auc_permanova"
output: html_document
date: '2022-10-03'
---

Muestras 

```{r}
getwd()
setwd("~/redes_correlacion_coocurrencia")
#Se cargan los datos de las muestras

data <- read.table("table.from_chile.txt", header = FALSE , sep= "" )

#Asumiendo que los otus pueden etiquetarse con números de 0 en adelante, y que la red puede describirse con estas etiquetas, se fijan
data$enum <- 0:(dim(data)-1)
head(data)
```

Separación artificial de las muestras para prueba

```{r}
data_1 <- data[,c(1,3,5,7)]
head(data_1)
data_2 <- data[,c(1,2,4,6,8)]
head(data_2)
```


```{r}
#Se carga la red
red <- read.csv("networks/chile_species_raw_network.csv")
red = red[,1:3]
head(red)
dim(red)
```

Calcular grado



```{r}
#Se ordenan las segundas entradas

red_2 <- red[order(red[,2]),]
red_2
```



```{r}

# Dar un Otu numerico
# variables son un OTU y un dataframe (red)
# red tiene tres columnas, dos de otus y una de coeficente
# funcion Ogrado_TOU_en_df

deg_otu <- function(df , otu){
  
  x_1 <- 1
  suma_otu <- 0
  
  while (x_1 <= dim(df)[1] && df[x_1, 1] != otu ){x_1 = x_1 + 1}
  
 
  
  while (x_1 <= dim(df)[1] && df[x_1 ,1] == otu ){ suma_otu = suma_otu + df[x_1 ,3]
  
  x_1 = x_1 + 1}
  
return(suma_otu)}


deg <- function(df){
  colnames(df) <- c("taxon1","taxon2","weight")
  df <- df[order(df[,1]),]
  df_2 <- df[order(df[,2]),]
  df_2 <- df_2[,c("taxon2","taxon1","weight")]
  # buscar manera más general de describir este vector
  otus <- c(df[1,1])
  j <- 2
  while (df[j,1] < df_2[1,1]) {
    if (otus[length(otus)] != df[j,1]){
      otus <- c(otus, df[j,1])
    }
    j <- j + 1 
  }
  
  k <- 1
  while (k <= dim(df_2)[1]) {
    if (otus[length(otus)] != df_2[k,1]){
      otus <- c(otus, df_2[k,1])
    }
    k <- k + 1 
  }
  
  vec_deg <- c()
  
  for (i in otus){
    if (df[1,1] != i){
      deg_i <- 0} else {
    deg_i <- deg_otu(df ,i)
    
    while (df[1,1] == i ) {df = df[-1,]  
    }}
    
    if (df_2[1,1] != i){
      deg_i = deg_i} else {
    deg_i <- deg_i + deg_otu(df_2 ,i)
    
    while (df_2[1,1] == i ) {df_2 = df_2[-1,]
    }}
    
    vec_deg = c(vec_deg ,deg_i)
    
  }
  return(cbind.data.frame(as.data.frame(otus),as.data.frame(vec_deg)) )
}

# entra OTU, df
# sale grado de OTU
#_______________________



deg(red)

```






```{r}
length(deg)
dim(data)
```
```{r}
head(deg)
head(data)
data_deg <- cbind(data,as.data.frame(deg))
data_1_deg <- cbind(data_1 ,as.data.frame(deg))
data_2_deg <- cbind(data_2 ,as.data.frame(deg))
head(data_deg)
```
```{r}
data_by_deg <- data_deg[order(data_deg[,9], decreasing = TRUE),]
head(data_by_deg)
data_1_by_deg <- data_1_deg[order(data_1_deg[,5], decreasing = TRUE),]
head(data_1_by_deg)
data_2_by_deg <- data_2_deg[order(data_2_deg[,6], decreasing = TRUE),]
head(data_2_by_deg)
```
```{r}
auc <- function(df_deg){
  sm_p <- 0
  for (i in 1:dim(df_deg)[1]) {
  f_i = df_deg[i,"deg"]
  if (f_i >= 0){sm_p = sm_p + f_i}
  else{sm_p = sm_p - f_i}
}

return(sm_p)}
```

```{r}
auc_percent <- function(df_deg, propo){
  i <- 1
  sum_par <- 0
  #c <- c() 
  while(i < dim(df_deg)[1] && sum_par < propo) {
    #c <- c(c,i)
    g_i = df_deg[i,"deg"]
    sum_par = sum_par + g_i
    i = i+1
  }
  return(i)
}
```


```{r}
area <- auc(data_by_deg)
c_auc5_percent <- c()
for (x in 1:20){
  c_auc5_percent = c(c_auc5_percent,auc_percent(data_by_deg, (area/20)*x))
  print(auc_percent(data_by_deg, (area/20)*x))
}
```


```{r}
library(vegan
        )
```

